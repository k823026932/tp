$(function(){function e(e){var a=document.createElement("div");return a.appendChild(document.createTextNode(e)),a.innerHTML}function a(e){var a=[],t="Safari"==H();for(var n in e)e.hasOwnProperty(n)&&void 0!=e[n]&&(t&&(e[n]=encodeURIComponent(e[n])),a.push(n+"="+e[n]));return a.join(";")}function t(e,a){$(e).each(function(e,t){var n=$(t).html().replace(/<!--[\s\S]*?-->/g,""),l=new RegExp("(>[^<\"']*?)"+a+"([^>\"']*?<)","g");l.test(n)&&(n=n.replace(l,"$1<span class='mark'>"+a+"</span>$2")),$(t).html(n)})}function n(e){$(".video-list .result-count span").text(e.totalCount+(e.sp&&e.sp.length||0)+(e.ai&&e.ai.length||0)),$(".article-list .result-count span").text(e.totalCount+(e.sp&&e.sp.length||0)),e.user&&$(".uper-list .result-count span").text(e.user.length||0)}function l(e){var a=$.makePager({num:e.pageNo,count:e.totalCount,size:e.pageSize,total:Math.ceil(e.totalCount/e.pageSize),addon:!0,hash:!0});$("#list-pager").html(a)}function i(a){$.getScript(d+(a||"")).done(function(){var a=$.parseJson($.parseString(system.think))||{};if(200==a.status){var t="";a.data.slice(0,4).forEach(function(a,n){t+='<a href="/search/#query='+a.name+'">'+e(a.name)+"</a>"}),$(".search-box-bg .word-wrap").html(t)}})}function s(e){if(e){switch($.searchCache(e),$.fomatHash().type){case"article":getData.article();break;case"uper":getData.uper();break;default:"bangumi"==b?getData.bangumi():2==O.type?getData.video():getData.album()}}}function o(e){u!==e?(E=(new Date).getTime(),$.ajax({type:"get",url:v+e+"?type=0",dataType:"json"}).done(function(e){e.data&&e.data.length>0?$.ajax({type:"get",url:h+e.data[0].count_id,dataType:"json"}).done(function(e){if(e.data&&e.data.compereList&&e.data.compereList.length>0){e.data.compereList.forEach(function(e,t){e.link=f+"#"+a({from:0,platform:e.platformId,videoId:e.videoId,compereId:e.compereId,isLive:e.isLive,contentId:e.id,liveType:e.liveType})}),$(".video-anchor-box").removeClass("hidden"),$(".video-anchor-wrap").html(z(e.data.compereList))}else $(".video-anchor-box").addClass("hidden")}).fail(function(e){$(".video-anchor-box").addClass("hidden")}):$(".video-anchor-box").addClass("hidden")}).fail(function(){$(".video-anchor-box").addClass("hidden")}),$.ajax({type:"get",url:v+e+"?type=1",dataType:"json"}).done(function(e){var a="";e.data&&e.data.length>0?(e.data.forEach(function(e,t){e.index=t,a+=q(e)}),$(".module-recommend .module-wrap").html(a),$(".module-recommend").removeClass("hidden"),$(".ad").addClass("hidden")):($(".module-recommend").addClass("hidden"),$(".ad").removeClass("hidden"))}).fail(function(){$(".module-recommend").addClass("hidden"),$(".ad").removeClass("hidden")}),i(e),u=e,s(u)):s(u)}function r(){var e=$.fomatHash(),a=e.type||"video";switch($("#search-text").val(e.query||""),a){case"article":D.pageNo=e.page||1;break;case"uper":T.pageNo=e.page||1;break;default:O.pageNo=e.page||1,_.pageNo=e.page||1}$(".search-nav li.active").removeClass("active"),$(".search-nav li[data-type="+a+"]").addClass("active"),$(".list-warp.active").removeClass("active"),$("."+a+"-list").addClass("active"),o(e.query||"")}function m(e,a){a.data().num<e?a.parent(".filter-wrap").find(".filter-btn").each(function(a,t){e>a?$(t).removeClass("extra"):$(t).addClass("extra")}):(a.parent(".filter-wrap").find(".filter-btn").each(function(a,t){e-1>a?$(t).removeClass("extra"):$(t).addClass("extra")}),a.removeClass("extra"))}var p=$.getQueryString("query");p&&(location.href="/search/#query="+p);var u,d="http://search.aixifan.com/think?cd=1&sys_name=pc&format=system.think&q=",c="http://search.aixifan.com/search",v="http://webapi.aixifan.com/searchAdKey/",h="http://webapi.aixifan.com/live/compere/recomSearch?compereIds=",f="http://live.acfun.tv/space",g="http://search.acfun.cn/search/album",b="video",y=!1,C=$.template($("#video-cell-template").html(),{variable:"video"}),w=$.template($("#album-cell-template").html(),{variable:"album"}),x=$.template($("#bangumi-cell-template").html(),{variable:"bangumi"}),S=$.template($("#article-cell-template").html(),{variable:"article"}),k=$.template($("#uper-cell-template").html(),{variable:"uper"}),I=$.template($("#video-filter-template").html(),{variable:"videoFilter"}),N=$.template($("#article-filter-template").html(),{variable:"articleFilter"}),q=$.template($("#right-cell-template").html(),{variable:"item"}),z=$.template($("#anchor-cell-template").html(),{variable:"anchor"}),E=(new Date).getTime(),O={cd:1,sys_name:"pc",format:"system.searchResult",pageSize:10,pageNo:1,aiCount:3,spCount:3,type:2,isWeb:1},D={cd:1,sys_name:"pc",format:"system.articleResult",pageSize:10,pageNo:1,aiCount:1,spCount:3,parentChannelId:63,type:2,isWeb:1},T={cd:1,sys_name:"pc",format:"system.uperResult",pageSize:0,pageNo:1,aiCount:0,spCount:0,userCount:10,type:2,isWeb:1},_={cd:1,format:"system.bangumiResult",isWeb:1,sort:0,pageNo:1,pageSize:10},j={sortArray:[{name:"相关",value:"score",sort:0},{name:"最新发布",value:"releaseDate",sort:1},{name:"最多围观",value:"views",sort:11},{name:"最多评论",value:"comments",sort:13}]},A={sortArray:[{name:"相关",value:"score",sort:0},{name:"最新发布",value:"releaseDate",sort:1},{name:"最多播放",value:"views",sort:11},{name:"最多评论",value:"comments",sort:13},{name:"最多弹幕",value:"danmakuSize",sort:17}],channelArray:[{name:"全部",value:"all",type:2},{name:"AC正义",value:178,type:2},{name:"动画",value:155,type:2},{name:"二次元",value:1,type:2},{name:"国产",value:179,type:2},{name:"音乐",value:58,type:2},{name:"舞蹈·彼女",value:123,type:2},{name:"游戏",value:59,type:2},{name:"娱乐",value:60,type:2},{name:"科技",value:70,type:2},{name:"体育",value:69,type:2},{name:"鱼塘",value:125,type:2},{name:"合辑",value:"album",type:1}],childChannelObj:{155:[{name:"全部",value:"all"},{value:67,name:"TV动画"},{value:180,name:"剧场动画 "},{value:181,name:" 短片动画"}],1:[{name:"全部",value:"all"},{value:106,name:"短片·手书"},{value:107,name:"MAD·AMV"},{value:108,name:"MMD·3D"},{value:159,name:"动画资讯"},{value:133,name:"COSPLAY·声优"},{value:99,name:"布袋·特摄"}],179:[{name:"全部",value:"all"},{value:120,name:"国产动画"},{value:182,name:"资讯·延伸"}],68:[{name:"全部",value:"all"},{value:96,name:"电影"},{value:162,name:"日剧"},{value:163,name:"美剧"},{value:141,name:"国产剧"},{value:121,name:"网络剧"},{value:142,name:"韩剧"},{value:99,name:"布袋·特摄"},{value:100,name:"纪录片"},{value:143,name:"其他"}],70:[{name:"全部",value:"all"},{value:90,name:"科学技术"},{value:149,name:"广告"},{value:91,name:"数码"},{value:151,name:"教程"},{value:122,name:"汽车"}],60:[{name:"全部",value:"all"},{value:86,name:"生活娱乐"},{value:87,name:"鬼畜调教"},{value:88,name:"萌宠"},{value:89,name:"美食"}],69:[{name:"全部",value:"all"},{value:152,name:"综合体育"},{value:94,name:"足球"},{value:95,name:"篮球"},{value:153,name:"搏击"},{value:154,name:"11区体育"},{value:93,name:"惊奇体育"}],123:[{name:"全部",value:"all"},{value:134,name:"宅舞"},{value:135,name:"综合舞蹈"},{value:127,name:"造型"},{value:129,name:"爱豆"},{value:130,name:"手作"}],125:[{name:"全部",value:"all"},{value:131,name:"历史"}],58:[{name:"全部",value:"all"},{value:136,name:"原创·翻唱"},{value:137,name:"演奏"},{value:103,name:"Vocaloid"},{value:138,name:"日系音乐"},{value:139,name:"综合音乐"},{value:140,name:"演唱会"}],59:[{name:"全部",value:"all"},{value:83,name:"游戏集锦"},{value:145,name:"电子竞技"},{value:84,name:"主机单机"},{value:85,name:"英雄联盟"},{value:170,name:"守望先锋"},{value:165,name:"桌游卡牌"},{value:72,name:"Mugen"}],bangumi:[{name:"全部",value:"all"},{value:1,name:"动画"},{value:2,name:"电影"},{value:3,name:"综艺"},{value:4,name:"电视剧"}]}},H=function(){var e=navigator.userAgent,a=e.indexOf("Opera")>-1;return a?"Opera":e.indexOf("Firefox")>-1?"FF":e.indexOf("Chrome")>-1?"Chrome":e.indexOf("Safari")>-1?"Safari":e.indexOf("compatible")>-1&&e.indexOf("MSIE")>-1&&!a?"IE":void 0};$("#list-pager").readyPager({addon:!0,callback:function(e){location.hash=a({page:e,query:$.fomatHash().query,type:$.fomatHash().type||"video"})}});var R;getData={video:function(){$.getScript(c+"?"+$.param($.extend({q:u,isArticle:1},O))).done(function(){var e=$.parseJson($.parseString(system.searchResult))||{},a="",i="",s="",o=0;200==e.status?(e.data.page.ai&&e.data.page.ai.forEach(function(e,a){e._position=++o,e.sets=[];var t=e.episodeName&&e.episodeName.length||0,n=!1;e.episodeName&&e.episodeName.forEach(function(a,l){3==e.status?5>l?e.sets.push({name:a,id:l}):2>=t-l?e.sets.push({name:a,id:l}):n||(e.sets.push({name:"...",id:0}),n=!0):2>l?e.sets.unshift({name:a,id:l}):5>=t-l?e.sets.unshift({name:a,id:l}):n||(e.sets.unshift({name:"...",id:0}),n=!0)}),s+=x(e)}),e.data.page.sp&&e.data.page.sp.forEach(function(e,a){e._position=++o,i+=w(e)}),e.data.page.list&&e.data.page.list.forEach(function(e,t){e._position=++o;var n=e.channelIds[1],l=e.channelIds[0];e.channelIds=[{},{}];for(var i=0;i<A.channelArray.length;i++)if(n==A.channelArray[i].value){e.channelIds[1]={id:n,name:A.channelArray[i].name};break}if(A.childChannelObj[n])for(var i=0;i<A.childChannelObj[n].length;i++)if(l==A.childChannelObj[n][i].value){e.channelIds[0]={id:l,name:A.childChannelObj[n][i].name};break}a+=C(e)}),n(e.data.page),l({pageNo:e.data.page.pageNo,totalCount:e.data.page.totalCount,pageSize:e.data.page.pageSize})):$.info.warning("搜索失败，请稍候再试"),$(".video-list-wrap").html(a),$(".video-album-wrap").html(i),$(".video-bangumi-wrap").html(s),t($(".video-list-wrap .video-cell"),u),t($(".video-album-wrap .album-cell"),u),t($(".video-bangumi-wrap .bangumi-cell"),u),i&&$(".video-album-wrap").append("<p class='more-album more'>查看全部合辑（"+e.data.page.sp.length+"）</p>"),s&&$(".video-bangumi-wrap").append("<p class='more-bangumi more'>全部番剧（"+e.data.page.aiCount+"）</p>"),R=$(".video-list-filter").find("#sort-count-5"),R.html("最多弹幕")}).fail(function(){$.info.warning("搜索失败，请稍候再试")})},bangumi:function(){17==_.sort&&(_.sort=15),$.getScript(g+"?"+$.param($.extend({q:u},_))).done(function(){var e=$.parseJson($.parseString(system.bangumiResult))||{},a="",i=0;200==e.status?(e.data.page.list&&e.data.page.list.length>0&&e.data.page.list.forEach(function(e,t){e._position=++i,e.tags=e.tagNames||[],e.description=e.intro,e.titleImg=e.cover,e.contentId=e.id,e.sets=[];var n=e.bangumVideosTitle&&e.bangumVideosTitle.length,l=!1;e.episodeName&&e.episodeName.forEach(function(a,t){3==e.status?5>t?e.sets.push({name:a,id:t+1}):2>=n-t?e.sets.push({name:a,id:t+1}):l||(e.sets.push({name:"...",id:1}),l=!0):2>t?e.sets.unshift({name:a,id:t+1}):5>=n-t?e.sets.unshift({name:a,id:t+1}):l||(e.sets.unshift({name:"...",id:1}),l=!0)}),a+=x(e)}),n(e.data.page),l({pageNo:e.data.page.pageNo,totalCount:e.data.page.totalCount,pageSize:e.data.page.pageSize})):$.info.warning("搜索失败，请稍候再试"),$(".video-bangumi-wrap").html(a),t($(".video-bangumi-wrap .bangumi-cell"),u),$(".video-album-wrap").empty(),$(".video-list-wrap").empty(),R.html("最多收藏")}).fail(function(){$.info.warning("搜索失败，请稍候再试")})},album:function(){$.getScript(c+"?"+$.param($.extend({q:u,mediaType:1},O))).done(function(){var e=$.parseJson($.parseString(system.searchResult))||{},a="",i=0;200==e.status?(e.data.page.list&&e.data.page.list.length>0&&e.data.page.list.forEach(function(e,t){e._position=++i,a+=w(e)}),n(e.data.page),l({pageNo:e.data.page.pageNo,totalCount:e.data.page.totalCount,pageSize:e.data.page.pageSize})):$.info.warning("搜索失败，请稍候再试"),$(".video-album-wrap").html(a),t($(".video-album-wrap .album-cell"),u),$(".video-list-wrap").empty(),$(".video-bangumi-wrap").empty(),R.html("最多弹幕")}).fail(function(){$.info.warning("搜索失败，请稍候再试")})},article:function(){$.getScript(c+"?"+$.param($.extend({q:u},D))).done(function(){var e=$.parseJson($.parseString(system.articleResult))||{},a="",i="",s=0;200==e.status?(e.data.page.sp&&e.data.page.sp.forEach(function(e,t){e._position=++s,a+=w(e)}),e.data.page.list&&e.data.page.list.length>0&&e.data.page.list.forEach(function(e,a){e._position=++s,i+=S(e)}),n(e.data.page),l({pageNo:e.data.page.pageNo,totalCount:e.data.page.totalCount,pageSize:e.data.page.pageSize})):$.info.warning("搜索失败，请稍候再试"),$(".article-album-wrap").html(a),$(".article-list-wrap").html(i),t($(".article-album-wrap .album-cell"),u),t($(".article-list-wrap .article-cell"),u),R.html("最多弹幕")}).fail(function(){$.info.warning("搜索失败，请稍候再试")})},uper:function(){$.getScript(c+"?"+$.param($.extend({q:u},T))).done(function(){var e=$.parseJson($.parseString(system.uperResult))||{},a="",i=0;200==e.status?(e.data.page.user&&e.data.page.user.length>0&&e.data.page.user.forEach(function(e,t){e._position=++i,a+=k(e)}),n(e.data.page),l({pageNo:e.data.page.pageNo,totalCount:e.data.page.user.length,pageSize:10})):$.info.warning("搜索失败，请稍候再试"),$(".uper-list-wrap").html(a),t($(".uper-list-wrap .uper-cell"),u),R.html("最多弹幕")}).fail(function(){$.info.warning("搜索失败，请稍候再试")})}},$(window).on("hashchange",function(e){r()}),$(".search-btn").click(function(e){var t=$.trim($("#search-text").val());t&&(e.stopPropagation(),e.preventDefault(),location.hash=a({page:1,query:t,type:$.fomatHash().type||"video"}))}),$(".column-left").delegate(".bgshow","click",function(){$(this).hasClass("cover")?($(this).removeClass("cover").html("展开全部"),$(this).siblings(".sets").addClass("max")):($(this).addClass("cover").html("收起全部"),$(this).siblings(".sets").removeClass("max"))}),$(".search-nav").on("click","li:not(.active)",function(e){location.hash=a({page:1,query:$.fomatHash().query,type:$(this).data("type")})}),$(".video-list-filter .filter-box-content").html(I(A)),$(".article-list-filter .filter-box-content").html(N(j)),$(".filter-box").on("click",".expand-btn span",function(){var e=$(this);switch(e.data("type")){case"whole":e.parents(".filter-box").removeClass("simple-mode");break;case"simple":e.parents(".filter-box").addClass("simple-mode")}e.addClass("hidden").siblings().removeClass("hidden")}),$(".filter-box").on("click",".filter-wrap span:not(.active)",function(e){var t=$(this);if(t.hasClass("more"))t.parents(".filter-box").find(".expand-btn .hidden").siblings().click();else{t.siblings(".active").removeClass("active");var n=t.addClass("active").data();switch(n.mode){case 1:switch(t.parents(".list-warp").data("type")){case"article":D.sortField=n.value;break;default:O.sortField=n.value,_.sort=n.sort,m(3,t)}break;case 2:switch(O.type=n.type,m(5,t),n.value){case"all":delete O.parentChannelId,delete O.channelId,b="video";break;case"bangumi":delete _.type,b="bangumi";break;case"album":delete O.parentChannelId,delete O.channelId,b="video";break;default:O.parentChannelId=n.value,delete O.channelId,b="video"}var l=A.childChannelObj[n.value];if(l){for(var i="",s=0;s<l.length;s++)i+="<span data-val='"+l[s].value+"' class='"+(0==s?"active":"")+"' data-mode='3'>"+l[s].name+"</span>";$(".child-channel-filter .filter-wrap").html(i),$(".child-channel-filter").removeClass("hidden")}else $(".child-channel-filter").addClass("hidden");break;case 3:"bangumi"==b?"nmuber"==typeof n.val?_.type=n.val:delete _.type:"number"==typeof n.val?O.channelId=n.val:delete O.channelId}y&&(1!=$.fomatHash().page?location.hash=a({page:1,query:u,type:$.fomatHash().type||"video"}):o(u))}}),$(".video-list").on("click",".more-album",function(){$(".channel-filter").find('[data-value="album"]').click()}),$(".sort-filter .filter-wrap span:first-child").click(),$(".channel-filter .filter-wrap span:first-child").click(),$(".column-left").on("click","a[target=_blank]",function(e){var a=$(this);$.fomatHash().query&&window.sa&&sa.track("ClickSearch",{keyword:$.fomatHash().query,result:a.attr("href"),position:parseInt(a.parents("[data-position]").data().position)||0,pagenumber:parseInt($.fomatHash().page)||1,range:$.fomatHash().type||"video",timecost:(new Date).getTime()-E})}),r(),y=!0});